<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Organic Naming Tutor AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Nunito', sans-serif; }
    
    /* Animations */
    .chat-bubble { animation: fadeInUp 0.4s ease-out; }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .pulse-btn { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
      50% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); }
    }

    /* Custom Scrollbar */
    #chat-container::-webkit-scrollbar { width: 6px; }
    #chat-container::-webkit-scrollbar-track { background: #f1f1f1; }
    #chat-container::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }

    /* Visualizer Atoms */
    .c-atom {
      transition: all 0.2s ease;
      cursor: pointer;
      width: 42px; height: 42px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
      background: white;
      border: 2px solid #d1fae5;
      color: #065f46;
      font-weight: 800;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .c-atom:hover { transform: scale(1.1); border-color: #10b981; }
    .c-atom.active { background: #10b981; color: white; border-color: #059669; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3); }

    /* Input Area Transition */
    #input-wrapper {
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
    }
    #input-wrapper.collapsed {
        transform: translateY(100%);
        opacity: 0;
        pointer-events: none;
        height: 0;
        padding: 0;
    }
  </style>
 </head>
 <body class="h-full bg-slate-50 text-slate-800">

  <div id="app" class="h-full w-full flex flex-col overflow-hidden relative max-w-md mx-auto bg-white shadow-2xl md:rounded-xl md:my-4 md:h-[95vh] border border-slate-100">
   
   <div id="welcome-screen" class="h-full w-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 absolute inset-0 z-50">
    <div class="text-center w-full">
     <div class="mb-6 flex justify-center">
        <img src="YOUR_GITHUB_IMAGE_URL_HERE" alt="Logo" class="h-32 w-auto object-contain drop-shadow-md" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1233/1233636.png'">
     </div>
     
     <h1 class="text-3xl md:text-4xl font-extrabold text-emerald-800 mb-3 tracking-tight">ChemTutor AI</h1>
     <p class="text-emerald-600 text-lg mb-8 font-medium">Master IUPAC Naming with <br>Constructive Feedback üß™</p>
     
     <button onclick="beginSession()" class="pulse-btn w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold text-xl px-8 py-4 rounded-2xl shadow-xl transition-all duration-300 hover:scale-[1.02]"> 
        Start Learning 
     </button>
    </div>
   </div>

   <div id="chat-screen" class="h-full w-full flex flex-col relative hidden">
    <header class="bg-white/80 backdrop-blur-md border-b border-emerald-100 px-4 py-3 flex items-center justify-between flex-shrink-0 z-10 sticky top-0">
     <div class="flex items-center gap-3">
      <div class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center font-bold">CT</div>
      <div>
       <h2 class="font-bold text-slate-800 text-sm leading-tight">Naming Session</h2>
       <p class="text-emerald-500 text-[10px] font-bold uppercase tracking-wider">Active Learning</p>
      </div>
     </div>
     <button onclick="startApp(true)" class="text-slate-400 hover:text-emerald-600 transition-colors p-2" title="Reset">
       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
     </button>
    </header>

    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50 pb-40">
        </div>

    <div id="input-wrapper" class="absolute bottom-0 left-0 right-0 bg-white border-t border-slate-100 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20 transition-all duration-300">
        <div id="input-content" class="p-4 flex flex-col gap-3 min-h-[140px] justify-center">
            <div id="controls" class="flex flex-wrap gap-2 justify-center w-full"></div>
            <div id="nav-area" class="w-full"></div>
        </div>
    </div>
   </div>

  </div>

  <script>
    // --- Data & Logic Configuration ---
    const roots = ["meth", "eth", "prop", "but", "pent", "hex", "hept", "oct", "non", "dec", "undec", "dodec"];
    const structureTypes = ["Straight Chain", "Cyclic Ring", "Benzene Ring"];

    const functionalGroups = [
        { name: "-COOH carboxyl", suffix: "oic acid", cyclicSuffix: "carboxylic acid", priority: 10, type: "terminal", allowMulti: true },
        { name: "-COOR carboalkoxy", suffix: "oate", cyclicSuffix: "carboxylate", priority: 9, type: "ester", allowMulti: false },
        { name: "-CONH‚ÇÇ carboxamide", suffix: "amide", cyclicSuffix: "carboxamide", priority: 8, type: "terminal", allowMulti: false },
        { name: "-CN cyano", suffix: "nitrile", cyclicSuffix: "carbonitrile", priority: 7, type: "terminal", allowMulti: false },
        { name: "-CHO carbonyl", suffix: "al", cyclicSuffix: "carbaldehyde", priority: 6, type: "terminal", allowMulti: true },
        { name: "-C=O carbonyl", suffix: "one", cyclicSuffix: "one", priority: 5, type: "internal", allowMulti: true },
        { name: "-OH hydroxyl", suffix: "ol", cyclicSuffix: "ol", priority: 4, type: "internal", allowMulti: true },
        { name: "-NH‚ÇÇ amino", suffix: "amine", cyclicSuffix: "amine", priority: 3, type: "internal", allowMulti: true },
        { name: "-C=C-", suffix: "ene", cyclicSuffix: "ene", priority: 2, type: "internal", allowMulti: true },
        { name: "-C-C-", suffix: "ane", cyclicSuffix: "ane", priority: 1, type: "none", allowMulti: false }
    ];

    const substituentsList = ["Methyl", "Ethyl", "Propyl", "isopropyl", "butyl", "phenyl", "cyclopropyl", "cyclobutyl", "benzyl", "Chloro", "Bromo", "Iodo", "Nitro", "Hydroxy", "Amino"];

    let state = { structureType: null, carbonCount: 0, group: null, groupCount: 1, groupLocants: [], esterAlkylCount: 0, substituents: [] };

    // --- UI Logic ---
    function showScreen(screenId) {
        ['welcome-screen', 'chat-screen'].forEach(id => {
            const el = document.getElementById(id);
            if(id === screenId) el.classList.remove('hidden');
            else el.classList.add('hidden');
        });
    }

    function addMessage(html, isUser = false) {
        const chat = document.getElementById("chat-container");
        const msgDiv = document.createElement("div");
        msgDiv.className = `chat-bubble flex ${isUser ? 'justify-end' : 'justify-start'}`;
        
        const bubbleStyle = isUser 
            ? "bg-emerald-600 text-white rounded-2xl rounded-tr-sm shadow-md" 
            : "bg-white text-slate-700 border border-slate-100 shadow-sm rounded-2xl rounded-tl-sm";

        msgDiv.innerHTML = `
            <div class="${bubbleStyle} px-5 py-3.5 max-w-[85%] text-[15px] leading-relaxed">
                ${html}
            </div>
        `;
        chat.appendChild(msgDiv);
        chat.scrollTop = chat.scrollHeight;
    }

    function addTeacherHint(text) {
        const chat = document.getElementById("chat-container");
        const msgDiv = document.createElement("div");
        msgDiv.className = "chat-bubble flex justify-start w-full";
        msgDiv.innerHTML = `
            <div class="bg-amber-50 text-amber-900 border border-amber-100 rounded-xl p-3 flex gap-3 max-w-[90%] text-sm items-start shadow-sm mx-1">
                <span class="text-lg">üí°</span>
                <div class="pt-0.5 leading-relaxed">${text}</div>
            </div>
        `;
        chat.appendChild(msgDiv);
        chat.scrollTop = chat.scrollHeight;
    }

    function clearControls() {
        document.getElementById("controls").innerHTML = "";
        document.getElementById("nav-area").innerHTML = "";
    }

    function toggleInputArea(visible) {
        const wrapper = document.getElementById("input-wrapper");
        if(visible) wrapper.classList.remove("collapsed");
        else wrapper.classList.add("collapsed");
    }

    // --- Inputs & Controls ---
    function createButtons(options, callback, backFn = null) {
        const controls = document.getElementById("controls");
        controls.innerHTML = "";
        options.forEach(opt => {
            const btn = document.createElement("button");
            btn.className = "bg-white hover:bg-emerald-50 text-slate-700 hover:text-emerald-700 font-semibold px-4 py-2.5 rounded-xl border border-slate-200 hover:border-emerald-300 transition-all text-sm shadow-sm active:scale-95";
            btn.innerText = opt;
            btn.onclick = () => callback(opt);
            controls.appendChild(btn);
        });
        addNavButtons(backFn);
    }

    function createNumberInput(max, callback, label = "Confirm", backFn = null) {
        const controls = document.getElementById("controls");
        controls.innerHTML = "";
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-center gap-2 bg-slate-50 p-1.5 rounded-xl border border-slate-200 shadow-sm";
        const select = document.createElement("select");
        select.className = "bg-transparent font-bold text-slate-700 text-lg py-1 px-2 focus:outline-none cursor-pointer";
        for(let i=1; i<=max; i++) {
            const opt = document.createElement("option"); opt.value = i; opt.text = i; select.appendChild(opt);
        }
        const btn = document.createElement("button");
        btn.className = "bg-emerald-600 hover:bg-emerald-700 text-white font-bold px-5 py-2 rounded-lg transition-colors text-sm shadow-md";
        btn.innerText = label;
        btn.onclick = () => callback(parseInt(select.value));
        wrapper.appendChild(select);
        wrapper.appendChild(btn);
        controls.appendChild(wrapper);
        addNavButtons(backFn);
    }

    function showChainVisualizer(count, targetSelections, callback, backFn = null, min = 1, max = null) {
        if (max === null) max = count;
        const controls = document.getElementById("controls");
        controls.innerHTML = "";
        const container = document.createElement("div");
        container.className = "w-full text-center";
        container.innerHTML = `<p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-3">Tap ${targetSelections} Position(s)</p>`;
        const grid = document.createElement("div");
        grid.className = "flex flex-wrap gap-3 justify-center mb-3";
        let limit = (state.structureType === "Benzene Ring") ? 6 : max;
        let start = (state.structureType === "Benzene Ring") ? 1 : min;
        let selections = [];
        for(let i=start; i<=limit; i++) {
            const atom = document.createElement("div");
            atom.className = "c-atom";
            atom.innerText = i;
            atom.onclick = () => {
                if (targetSelections === 1) {
                    callback(i);
                } else {
                    if(selections.includes(i)) {
                        selections = selections.filter(s => s !== i);
                        atom.classList.remove("active");
                    } else if (selections.length < targetSelections) {
                        selections.push(i);
                        atom.classList.add("active");
                    }
                }
            };
            grid.appendChild(atom);
        }
        container.appendChild(grid);
        if (targetSelections > 1) {
            const btn = document.createElement("button");
            btn.className = "bg-emerald-600 text-white font-bold px-6 py-2 rounded-full shadow-lg text-sm";
            btn.innerText = "Confirm Selection";
            btn.onclick = () => {
                if(selections.length === targetSelections) callback(selections);
                else alert(`Please select exactly ${targetSelections} positions.`);
            };
            container.appendChild(btn);
        }
        controls.appendChild(container);
        addNavButtons(backFn);
    }

    function addNavButtons(backFunction) {
        const navArea = document.getElementById("nav-area");
        navArea.innerHTML = "";
        const wrapper = document.createElement("div");
        wrapper.className = "flex justify-between items-center w-full mt-2 pt-2 border-t border-slate-100";
        if (backFunction) {
            const backBtn = document.createElement("button");
            backBtn.className = "text-slate-400 hover:text-slate-600 text-xs font-bold uppercase tracking-wide flex items-center gap-1 py-2 px-2 rounded hover:bg-slate-100 transition";
            backBtn.innerHTML = "‚Üê Back";
            backBtn.onclick = backFunction;
            wrapper.appendChild(backBtn);
        } else {
            wrapper.appendChild(document.createElement("div")); 
        }
        const resetBtn = document.createElement("button");
        resetBtn.className = "text-rose-400 hover:text-rose-600 text-xs font-bold uppercase tracking-wide py-2 px-2 rounded hover:bg-rose-50 transition";
        resetBtn.innerHTML = "Reset";
        resetBtn.onclick = () => startApp(true);
        wrapper.appendChild(resetBtn);
        navArea.appendChild(wrapper);
    }

    // --- Application Logic ---
    function startApp(isFirstRun = false) {
        if(isFirstRun) {
            showScreen('welcome-screen');
        } else {
            showScreen('chat-screen');
            toggleInputArea(true);
            state = { structureType: null, carbonCount: 0, group: null, groupCount: 1, groupLocants: [], substituents: [] };
            clearControls();
            const separator = document.createElement('div');
            separator.className = "flex items-center py-6 text-slate-300 text-xs font-bold uppercase tracking-widest";
            separator.innerHTML = "<div class='flex-1 border-t border-slate-200'></div><span class='px-4'>New Session</span><div class='flex-1 border-t border-slate-200'></div>";
            document.getElementById('chat-container').appendChild(separator);
            setTimeout(askFunctionalGroup, 400);
        }
    }

    function beginSession() {
        showScreen('chat-screen');
        toggleInputArea(true); 
        document.getElementById('chat-container').innerHTML = ''; 
        addMessage("Hi! I'm ChemTutor. I'll help you build IUPAC names and explain the rules along the way. üëã");
        state = { structureType: null, carbonCount: 0, group: null, groupCount: 1, groupLocants: [], substituents: [] };
        setTimeout(askFunctionalGroup, 600);
    }

    function askFunctionalGroup() {
        addMessage("1. What is the main functional group?");
        createButtons(functionalGroups.map(g => g.name), (choice) => {
            addMessage(choice, true);
            state.group = functionalGroups.find(g => g.name === choice);
            if(state.group.name === "-C-C-") {
                addTeacherHint("<b>Rule:</b> Alkanes are the base hydrocarbons with single bonds. The suffix is <b>-ane</b>.");
            } else {
                addTeacherHint(`<b>Priority Rule:</b> The ${state.group.name} has the highest priority here. It determines the parent suffix: <b>-${state.group.suffix}</b>.`);
            }
            if (state.group.type === "ester") askEsterAlkyl();
            else if (state.group.allowMulti) askGroupCount();
            else askStructureType();
        }, () => startApp(true));
    }

    function askGroupCount() {
        addMessage(`How many <b>${state.group.name}</b> groups?`);
        createButtons(["1 (Mono)", "2 (Di)", "3 (Tri)"], (choice) => {
            state.groupCount = parseInt(choice.charAt(0));
            addMessage(choice, true);
            if(state.groupCount > 1) {
                addTeacherHint(`<b>Multiplier Rule:</b> Since there are ${state.groupCount} functional groups, we insert a multiplier <b>'${state.groupCount === 2 ? 'di' : 'tri'}'</b> before the suffix.`);
            }
            askStructureType();
        }, askFunctionalGroup);
    }

    function askEsterAlkyl() {
        addMessage("Carbons in the alkyl group (attached to Oxygen)?");
        createNumberInput(10, (num) => {
            addMessage(`${num} (${roots[num-1]}yl)`, true);
            state.esterAlkylCount = num;
            addTeacherHint(`<b>Ester Rule:</b> The alkyl group attached to the oxygen is named first as a separate word: <b>${roots[num-1]}yl</b>.`);
            askEsterAcid();
        }, "Next", askFunctionalGroup);
    }

    function askEsterAcid() {
        addMessage("Carbons in the parent acid chain?");
        createNumberInput(10, (num) => {
            addMessage(num.toString(), true);
            state.carbonCount = num;
            state.structureType = "Straight Chain"; 
            askSubstituents(askEsterAcid);
        }, "Next", askEsterAlkyl);
    }

    function askStructureType() {
        addMessage("What is the parent skeleton?");
        createButtons(structureTypes, (choice) => {
            addMessage(choice, true);
            state.structureType = choice;
            if (choice === "Cyclic Ring") {
                if (state.group.cyclicSuffix !== state.group.suffix) {
                    addTeacherHint(`<b>Cyclic Suffix Rule:</b> When a carbon-containing group (like ${state.group.name}) is attached to a ring, the suffix changes to <b>-${state.group.cyclicSuffix}</b> because the functional carbon is outside the ring.`);
                } else {
                    addTeacherHint("<b>Cyclic Prefix Rule:</b> We add the prefix <b>cyclo-</b> to the root name to indicate a ring structure.");
                }
                askCarbonCount();
            } else if (choice === "Benzene Ring") {
                state.carbonCount = 6;
                addTeacherHint("<b>Aromatic Nomenclature:</b> Benzene derivatives often use retained common names (e.g., Phenol for -OH on Benzene) which are accepted by IUPAC.");
                checkBenzeneRules();
            } else {
                addTeacherHint("Standard straight chain IUPAC rules apply.");
                askCarbonCount();
            }
        }, () => state.group.allowMulti ? askGroupCount() : askFunctionalGroup());
    }

    function askCarbonCount() {
        addMessage(`How many carbons in the ${state.structureType.includes("Ring")?"ring":"chain"}?`);
        createNumberInput(10, (num) => {
            addMessage(num.toString(), true);
            if (state.group.name === "Ketone" && !state.structureType.includes("Ring") && num < 3) return addMessage(`<span class="text-rose-500 font-bold">‚ö†Ô∏è Error: A chain ketone requires at least 3 carbons.</span>`);
            if (state.structureType.includes("Ring") && num < 3) return addMessage(`<span class="text-rose-500 font-bold">‚ö†Ô∏è Error: A ring requires at least 3 carbons.</span>`);

            state.carbonCount = num;
            let root = roots[num-1];
            if(state.structureType.includes("Ring")) root = "cyclo" + root;
            addTeacherHint(`<b>Root Name:</b> ${num} carbons corresponds to the root <b>"${root}"</b>.`);
            askGroupLocant();
        }, "Confirm", askStructureType);
    }

    function checkBenzeneRules() {
        state.groupLocants = [1];
        if (state.groupCount > 1) askGroupLocant();
        else askSubstituents(askStructureType);
    }

    function askGroupLocant() {
        if (state.group.name === "-C-C-") { state.groupLocants = []; return askSubstituents(askCarbonCount); }
        if (state.group.type === "terminal" && state.structureType === "Straight Chain") {
            if (state.groupCount === 1) state.groupLocants = [1];
            else if (state.groupCount === 2) state.groupLocants = [1, state.carbonCount];
            addTeacherHint("<b>Locant Rule:</b> Terminal groups are always at position 1 (and the end), so numbering is implied and omitted.");
            return askSubstituents(askCarbonCount);
        }

        addMessage(`Select <b>${state.groupCount}</b> position(s) for ${state.group.name}:`);
        let min = 1, max = state.carbonCount;
        if (state.group.name === "Ketone" && state.structureType === "Straight Chain") { min = 2; max = state.carbonCount-1; }

        showChainVisualizer(state.carbonCount, state.groupCount, (selection) => {
            const locs = Array.isArray(selection) ? selection : [selection];
            locs.sort((a,b)=>a-b);
            state.groupLocants = locs;
            addMessage(`Positions: ${locs.join(",")}`, true);
            let partialName = constructName(true);
            addTeacherHint(`<b>Preview:</b> Based on your choices, the parent name is forming as: <b>${partialName}...</b>`);
            askSubstituents(() => askGroupLocant()); 
        }, askCarbonCount, min, max);
    }

    function askSubstituents(backFromHub) {
        addMessage("Any branches/substituents?");
        createButtons(["Add Substituent", "Finish"], (choice) => {
            if (choice === "Finish") {
                addMessage("Finish", true);
                finalizeName();
            } else {
                addMessage("Add Substituent", true);
                askSubType(() => askSubstituents(backFromHub));
            }
        }, () => { state.substituents=[]; if(backFromHub) backFromHub(); });
    }

    function askSubType(backFn) {
        addMessage("Type:");
        createButtons(substituentsList, (choice) => {
            addMessage(choice, true);
            askSubPos(choice, backFn);
        }, backFn);
    }

    function askSubPos(name, backFn) {
        addMessage(`Position of <b>${name}</b>?`);
        showChainVisualizer(state.carbonCount, 1, (pos) => {
            addMessage(`At ${pos}`, true);
            state.substituents.push({name: name, locant: pos});
            addTeacherHint(`<b>Alphabetizing:</b> Substituents like <b>${name}</b> are placed in the prefix, sorted alphabetically.`);
            askSubstituents(askStructureType); 
        }, backFn);
    }

    // --- Core Naming Logic ---
    function constructName(isPartial = false) {
        let root = roots[state.carbonCount - 1];
        let parentPrefix = "";
        
        if(state.structureType === "Benzene Ring") root = "benzene";
        else if(state.structureType.includes("Ring")) parentPrefix = "cyclo";

        let prefixes = isPartial ? "" : buildPrefixString();
        if(prefixes.endsWith("-")) prefixes = prefixes.slice(0, -1);

        if (state.group.name === "-C-C-") {
            // FIX: Benzene has no 'ane' suffix, Cycloalkane does
            let suffix = (state.structureType === "Benzene Ring") ? "" : "ane";
            let base = parentPrefix + root + suffix;
            return prefixes + base;
        }

        let multiplier = "";
        if(state.groupCount === 2) multiplier = "di";
        if(state.groupCount === 3) multiplier = "tri";

        let useCyclicSuffix = (state.structureType === "Cyclic Ring") && (state.group.cyclicSuffix !== state.group.suffix);
        let rawSuffix = useCyclicSuffix ? state.group.cyclicSuffix : state.group.suffix;
        let fullSuffix = multiplier + rawSuffix; 

        let bond = "an";
        if (state.group.name === "Alkene") bond = "en";
        if (state.structureType === "Benzene Ring") bond = "";

        if (state.structureType === "Benzene Ring" && state.groupCount === 1) {
            const specials = {"Carboxylic Acid":"benzoic acid", "Alcohol":"phenol", "Amine":"aniline", "Aldehyde":"benzaldehyde"};
            if (specials[state.group.name]) return buildBenzeneSpecial(specials[state.group.name], isPartial);
        }

        if (state.group.name === "-COOR carboalkoxy") {
            let acidPart = parentPrefix + root + "an";
            let alkylPart = roots[state.esterAlkylCount - 1] + "yl";
            let p = isPartial ? "" : buildPrefixString();
            if(p.endsWith("-")) p = p.slice(0, -1);
            let mainPart = `${p}${acidPart}${rawSuffix}`;
            return `${alkylPart} ${mainPart}`.trim();
        }

        let parentName = "";
        if (state.group.name === "Alkene") {
            parentName = (state.groupCount > 1) ? parentPrefix + root + "a" : parentPrefix + root;
        } else {
             let bondWithE = bond + "e"; 
             let isVowel = ['a','e','i','o','u','y'].includes(fullSuffix.charAt(0).toLowerCase());
             parentName = isVowel ? parentPrefix + root + bond : parentPrefix + root + bondWithE; 
        }

        let suffixWithLocants = "";
        let skipLocant = (state.structureType === "Straight Chain" && state.group.type === "terminal") || state.group.name === "-C-C-";
        
        if (skipLocant) suffixWithLocants = fullSuffix;
        else suffixWithLocants = `-${state.groupLocants.join(",")}-${fullSuffix}`;

        let base = parentName + suffixWithLocants;
        base = base.replace("--", "-").replace(/^-/, "");

        return prefixes + base;
    }

    function buildBenzeneSpecial(specialRoot, isPartial) {
        if(isPartial) return specialRoot;
        let prefix = buildPrefixString();
        if (prefix.endsWith("-")) prefix = prefix.slice(0, -1);
        return prefix + specialRoot;
    }

    function buildPrefixString() {
        if(state.substituents.length === 0) return "";
        state.substituents.sort((a,b) => a.name.localeCompare(b.name));
        let groups = {};
        state.substituents.forEach(s => {
            if(!groups[s.name]) groups[s.name] = [];
            groups[s.name].push(s.locant);
        });
        let str = "";
        const mults = ["", "di", "tri", "tetra", "penta"];
        Object.keys(groups).sort().forEach(k => {
            let locs = groups[k].sort((a,b)=>a-b).join(",");
            let m = groups[k].length > 1 ? mults[groups[k].length-1] : "";
            str += `${locs}-${m}${k.toLowerCase()}-`;
        });
        return str;
    }

    // --- Finalization with DUAL CHECK (NCI + PubChem) ---

    async function finalizeName() {
        clearControls();
        toggleInputArea(false); 

        const generatedName = constructName();
        addMessage("Verifying name with NCI & PubChem...", false);

        let finalDisplayName = generatedName;
        let badgeHtml = `<span class="status-badge bg-amber-100 text-amber-800 text-xs font-bold px-3 py-1 rounded-full border border-amber-200">‚ö†Ô∏è Theoretical</span>`;
        let linkHtml = "";
        let metaText = "Generated via internal rules";
        let isVerified = false;
        
        // 1. Try NCI CACTUS Resolver (Superior for structure correction)
        try {
            const nciResp = await fetch(`https://cactus.nci.nih.gov/chemical/structure/${encodeURIComponent(generatedName)}/iupac_name`);
            if (nciResp.ok) {
                const nciName = await nciResp.text();
                // NCI returns simple text. If text is short and valid:
                if (nciName && nciName.length < 100 && !nciName.includes("html")) {
                    finalDisplayName = nciName;
                    metaText = `Corrected by NCI Resolver (Input: ${generatedName})`;
                    badgeHtml = `<span class="status-badge bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full border border-blue-200">‚úÖ Verified by NCI</span>`;
                    isVerified = true;
                }
            }
        } catch (e) { console.log("NCI Check Failed", e); }

        // 2. Try PubChem (Secondary Check + Link Source)
        try {
            // Use the NCI-corrected name if available, otherwise generated name
            const searchName = isVerified ? finalDisplayName : generatedName;
            
            const resp = await fetch(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(searchName)}/cids/JSON`);
            if (resp.ok) {
                const data = await resp.json();
                if (data.IdentifierList && data.IdentifierList.CID) {
                    const cid = data.IdentifierList.CID[0];
                    linkHtml = `<a href="https://pubchem.ncbi.nlm.nih.gov/compound/${cid}" target="_blank" class="block mt-4 text-emerald-600 hover:text-emerald-800 text-sm font-bold underline">View on PubChem &rarr;</a>`;
                    
                    // If not verified by NCI yet, use PubChem's preferred name
                    if (!isVerified) {
                        const propResp = await fetch(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/property/IUPACName/JSON`);
                        if(propResp.ok) {
                            const propData = await propResp.json();
                            const officialName = propData.PropertyTable?.Properties[0]?.IUPACName;
                            if (officialName) {
                                finalDisplayName = officialName;
                                metaText = `Official Verified Name (Generated: ${generatedName})`;
                                badgeHtml = `<span class="status-badge bg-emerald-100 text-emerald-800 text-xs font-bold px-3 py-1 rounded-full border border-emerald-200">‚úÖ Verified by PubChem</span>`;
                            }
                        }
                    } else {
                        // Confirmed by BOTH
                        badgeHtml = `<span class="status-badge bg-purple-100 text-purple-800 text-xs font-bold px-3 py-1 rounded-full border border-purple-200">‚ú® Verified (NCI & PubChem)</span>`;
                    }
                }
            }
        } catch (e) { console.log("PubChem Check Failed", e); }

        const imgUrl = `https://opsin.ch.cam.ac.uk/opsin/${encodeURIComponent(finalDisplayName)}.png`;

        const resultHtml = `
            <div class="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden mt-2 mx-auto w-full max-w-sm">
                <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Result</span>
                    ${badgeHtml}
                </div>
                <div class="p-6 text-center">
                    <h2 class="text-2xl font-extrabold text-slate-800 break-words mb-2">${finalDisplayName}</h2>
                    <p class="text-xs text-slate-500 mb-6 font-mono">${metaText}</p>
                    <div class="bg-white rounded-xl p-2 border border-slate-100 shadow-inner inline-block">
                        <img src="${imgUrl}" alt="Structure" class="max-w-[240px] h-auto mix-blend-multiply" onerror="this.style.display='none'">
                    </div>
                    ${linkHtml}
                </div>
                <div class="bg-slate-50 px-4 py-4 border-t border-slate-100 text-center">
                    <button onclick="startApp(false)" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform active:scale-95 text-sm w-full">
                        Name Another Compound
                    </button>
                </div>
            </div>
        `;

        const chat = document.getElementById("chat-container");
        const div = document.createElement("div");
        div.className = "w-full flex justify-center py-2 fade-in";
        div.innerHTML = resultHtml;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }
  </script>
 </body>
</html>
